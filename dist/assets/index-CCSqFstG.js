import{S as se,z as n}from"./index-CRwBhgXv.js";import"./index-CjVg0o4A.js";function qe(e){let s,t,r,i,a,l,o;return c(),{feed:d,reset:c};function c(){s=!0,t="",r=0,i=-1,a=void 0,l=void 0,o=""}function d(g){t=t?t+g:g,s&&Ve(t)&&(t=t.slice(me.length)),s=!1;const p=t.length;let u=0,h=!1;for(;u<p;){h&&(t[u]===`
`&&++u,h=!1);let f=-1,b=i,v;for(let w=r;f<0&&w<p;++w)v=t[w],v===":"&&b<0?b=w-u:v==="\r"?(h=!0,f=w-u):v===`
`&&(f=w-u);if(f<0){r=p-u,i=b;break}else r=0,i=-1;m(t,u,b,f),u+=f+1}u===p?t="":u>0&&(t=t.slice(u))}function m(g,p,u,h){if(h===0){o.length>0&&(e({type:"event",id:a,event:l||void 0,data:o.slice(0,-1)}),o="",a=void 0),l=void 0;return}const f=u<0,b=g.slice(p,p+(f?h:u));let v=0;f?v=h:g[p+u+1]===" "?v=u+2:v=u+1;const w=p+v,T=h-v,E=g.slice(w,w+T).toString();if(b==="data")o+=E?"".concat(E,`
`):`
`;else if(b==="event")l=E;else if(b==="id"&&!E.includes("\0"))a=E;else if(b==="retry"){const A=parseInt(E,10);Number.isNaN(A)||e({type:"reconnect-interval",value:A})}}}const me=[239,187,191];function Ve(e){return me.every((s,t)=>e.charCodeAt(t)===s)}class Be extends TransformStream{constructor(){let s;super({start(t){s=qe(r=>{r.type==="event"&&t.enqueue(r)})},transform(t){s.feed(t)}})}}let Le=(e,s=21)=>(t=s)=>{let r="",i=t;for(;i--;)r+=e[Math.random()*e.length|0];return r};var he="vercel.ai.error",Fe=Symbol.for(he),ge,Ue=class fe extends Error{constructor({name:s,message:t,cause:r}){super(t),this[ge]=!0,this.name=s,this.cause=r}static isInstance(s){return fe.hasMarker(s,he)}static hasMarker(s,t){const r=Symbol.for(t);return s!=null&&typeof s=="object"&&r in s&&typeof s[r]=="boolean"&&s[r]===!0}toJSON(){return{name:this.name,message:this.message}}};ge=Fe;var y=Ue,D="AI_APICallError",ye=`vercel.ai.error.${D}`,De=Symbol.for(ye),be,x=class extends y{constructor({message:e,url:s,requestBodyValues:t,statusCode:r,responseHeaders:i,responseBody:a,cause:l,isRetryable:o=r!=null&&(r===408||r===409||r===429||r>=500),data:c}){super({name:D,message:e,cause:l}),this[be]=!0,this.url=s,this.requestBodyValues=t,this.statusCode=r,this.responseHeaders=i,this.responseBody=a,this.isRetryable=o,this.data=c}static isInstance(e){return y.hasMarker(e,ye)}static isAPICallError(e){return e instanceof Error&&e.name===D&&typeof e.url=="string"&&typeof e.requestBodyValues=="object"&&(e.statusCode==null||typeof e.statusCode=="number")&&(e.responseHeaders==null||typeof e.responseHeaders=="object")&&(e.responseBody==null||typeof e.responseBody=="string")&&(e.cause==null||typeof e.cause=="object")&&typeof e.isRetryable=="boolean"&&(e.data==null||typeof e.data=="object")}toJSON(){return{name:this.name,message:this.message,url:this.url,requestBodyValues:this.requestBodyValues,statusCode:this.statusCode,responseHeaders:this.responseHeaders,responseBody:this.responseBody,cause:this.cause,isRetryable:this.isRetryable,data:this.data}}};be=De;var K="AI_EmptyResponseBodyError",ve=`vercel.ai.error.${K}`,Ke=Symbol.for(ve),we,ze=class extends y{constructor({message:e="Empty response body"}={}){super({name:K,message:e}),this[we]=!0}static isInstance(e){return y.hasMarker(e,ve)}static isEmptyResponseBodyError(e){return e instanceof Error&&e.name===K}};we=Ke;function _e(e){return e==null?"unknown error":typeof e=="string"?e:e instanceof Error?e.message:JSON.stringify(e)}var z="AI_InvalidPromptError",ke=`vercel.ai.error.${z}`,Ge=Symbol.for(ke),Ee,Ye=class extends y{constructor({prompt:e,message:s,cause:t}){super({name:z,message:`Invalid prompt: ${s}`,cause:t}),this[Ee]=!0,this.prompt=e}static isInstance(e){return y.hasMarker(e,ke)}static isInvalidPromptError(e){return e instanceof Error&&e.name===z&&prompt!=null}toJSON(){return{name:this.name,message:this.message,stack:this.stack,prompt:this.prompt}}};Ee=Ge;var G="AI_InvalidResponseDataError",Ie=`vercel.ai.error.${G}`,Qe=Symbol.for(Ie),Ce,F=class extends y{constructor({data:e,message:s=`Invalid response data: ${JSON.stringify(e)}.`}){super({name:G,message:s}),this[Ce]=!0,this.data=e}static isInstance(e){return y.hasMarker(e,Ie)}static isInvalidResponseDataError(e){return e instanceof Error&&e.name===G&&e.data!=null}toJSON(){return{name:this.name,message:this.message,stack:this.stack,data:this.data}}};Ce=Qe;var Y="AI_JSONParseError",xe=`vercel.ai.error.${Y}`,We=Symbol.for(xe),Se,H=class extends y{constructor({text:e,cause:s}){super({name:Y,message:`JSON parsing failed: Text: ${e}.
Error message: ${_e(s)}`,cause:s}),this[Se]=!0,this.text=e}static isInstance(e){return y.hasMarker(e,xe)}static isJSONParseError(e){return e instanceof Error&&e.name===Y&&"text"in e&&typeof e.text=="string"}toJSON(){return{name:this.name,message:this.message,cause:this.cause,stack:this.stack,valueText:this.text}}};Se=We;var Q="AI_LoadAPIKeyError",Te=`vercel.ai.error.${Q}`,Xe=Symbol.for(Te),je,M=class extends y{constructor({message:e}){super({name:Q,message:e}),this[je]=!0}static isInstance(e){return y.hasMarker(e,Te)}static isLoadAPIKeyError(e){return e instanceof Error&&e.name===Q}};je=Xe;var W="AI_TooManyEmbeddingValuesForCallError",Ae=`vercel.ai.error.${W}`,Ze=Symbol.for(Ae),Oe,et=class extends y{constructor(e){super({name:W,message:`Too many values for a single embedding call. The ${e.provider} model "${e.modelId}" can only embed up to ${e.maxEmbeddingsPerCall} values per call, but ${e.values.length} values were provided.`}),this[Oe]=!0,this.provider=e.provider,this.modelId=e.modelId,this.maxEmbeddingsPerCall=e.maxEmbeddingsPerCall,this.values=e.values}static isInstance(e){return y.hasMarker(e,Ae)}static isTooManyEmbeddingValuesForCallError(e){return e instanceof Error&&e.name===W&&"provider"in e&&typeof e.provider=="string"&&"modelId"in e&&typeof e.modelId=="string"&&"maxEmbeddingsPerCall"in e&&typeof e.maxEmbeddingsPerCall=="number"&&"values"in e&&Array.isArray(e.values)}toJSON(){return{name:this.name,message:this.message,stack:this.stack,provider:this.provider,modelId:this.modelId,maxEmbeddingsPerCall:this.maxEmbeddingsPerCall,values:this.values}}};Oe=Ze;var X="AI_TypeValidationError",Ne=`vercel.ai.error.${X}`,tt=Symbol.for(Ne),Pe,st=class Z extends y{constructor({value:s,cause:t}){super({name:X,message:`Type validation failed: Value: ${JSON.stringify(s)}.
Error message: ${_e(t)}`,cause:t}),this[Pe]=!0,this.value=s}static isInstance(s){return y.hasMarker(s,Ne)}static wrap({value:s,cause:t}){return Z.isInstance(t)&&t.value===s?t:new Z({value:s,cause:t})}static isTypeValidationError(s){return s instanceof Error&&s.name===X}toJSON(){return{name:this.name,message:this.message,cause:this.cause,stack:this.stack,value:this.value}}};Pe=tt;var q=st,ee="AI_UnsupportedFunctionalityError",$e=`vercel.ai.error.${ee}`,nt=Symbol.for($e),Re,k=class extends y{constructor({functionality:e}){super({name:ee,message:`'${e}' functionality not supported.`}),this[Re]=!0,this.functionality=e}static isInstance(e){return y.hasMarker(e,$e)}static isUnsupportedFunctionalityError(e){return e instanceof Error&&e.name===ee&&typeof e.functionality=="string"}toJSON(){return{name:this.name,message:this.message,stack:this.stack,functionality:this.functionality}}};Re=nt;var rt={};function P(...e){return e.reduce((s,t)=>({...s,...t??{}}),{})}function B(e){const s={};return e.headers.forEach((t,r)=>{s[r]=t}),s}var N=Le("0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz",7);function U(e){return e instanceof Error&&(e.name==="AbortError"||e.name==="TimeoutError")}function ot({apiKey:e,environmentVariableName:s,apiKeyParameterName:t="apiKey",description:r}){if(typeof e=="string")return e;if(e!=null)throw new M({message:`${r} API key must be a string.`});if(typeof process>"u")throw new M({message:`${r} API key is missing. Pass it using the '${t}' parameter. Environment variables is not supported in this environment.`});if(e=rt[s],e==null)throw new M({message:`${r} API key is missing. Pass it using the '${t}' parameter or the ${s} environment variable.`});if(typeof e!="string")throw new M({message:`${r} API key must be a string. The value of the ${s} environment variable is not a string.`});return e}var te=Symbol.for("vercel.ai.validator");function at(e){return{[te]:!0,validate:e}}function it(e){return typeof e=="object"&&e!==null&&te in e&&e[te]===!0&&"validate"in e}function lt(e){return it(e)?e:ut(e)}function ut(e){return at(s=>{const t=e.safeParse(s);return t.success?{success:!0,value:t.data}:{success:!1,error:t.error}})}function ct({value:e,schema:s}){const t=Je({value:e,schema:s});if(!t.success)throw q.wrap({value:e,cause:t.error});return t.value}function Je({value:e,schema:s}){const t=lt(s);try{if(t.validate==null)return{success:!0,value:e};const r=t.validate(e);return r.success?r:{success:!1,error:q.wrap({value:e,cause:r.error})}}catch(r){return{success:!1,error:q.wrap({value:e,cause:r})}}}function pt({text:e,schema:s}){try{const t=se.parse(e);return s==null?t:ct({value:t,schema:s})}catch(t){throw H.isJSONParseError(t)||q.isTypeValidationError(t)?t:new H({text:e,cause:t})}}function Me({text:e,schema:s}){try{const t=se.parse(e);return s==null?{success:!0,value:t}:Je({value:t,schema:s})}catch(t){return{success:!1,error:H.isJSONParseError(t)?t:new H({text:e,cause:t})}}}function ce(e){try{return se.parse(e),!0}catch{return!1}}function dt(e){return Object.fromEntries(Object.entries(e).filter(([s,t])=>t!=null))}var mt=()=>globalThis.fetch,$=async({url:e,headers:s,body:t,failedResponseHandler:r,successfulResponseHandler:i,abortSignal:a,fetch:l})=>ht({url:e,headers:{"Content-Type":"application/json",...s},body:{content:JSON.stringify(t),values:t},failedResponseHandler:r,successfulResponseHandler:i,abortSignal:a,fetch:l}),ht=async({url:e,headers:s={},body:t,successfulResponseHandler:r,failedResponseHandler:i,abortSignal:a,fetch:l=mt()})=>{try{const o=await l(e,{method:"POST",headers:dt(s),body:t.content,signal:a}),c=B(o);if(!o.ok){let d;try{d=await i({response:o,url:e,requestBodyValues:t.values})}catch(m){throw U(m)||x.isAPICallError(m)?m:new x({message:"Failed to process error response",cause:m,statusCode:o.status,url:e,responseHeaders:c,requestBodyValues:t.values})}throw d.value}try{return await r({response:o,url:e,requestBodyValues:t.values})}catch(d){throw d instanceof Error&&(U(d)||x.isAPICallError(d))?d:new x({message:"Failed to process successful response",cause:d,statusCode:o.status,url:e,responseHeaders:c,requestBodyValues:t.values})}}catch(o){if(U(o))throw o;if(o instanceof TypeError&&o.message==="fetch failed"){const c=o.cause;if(c!=null)throw new x({message:`Cannot connect to API: ${c.message}`,cause:c,url:e,requestBodyValues:t.values,isRetryable:!0})}throw o}},gt=({errorSchema:e,errorToMessage:s,isRetryable:t})=>async({response:r,url:i,requestBodyValues:a})=>{const l=await r.text(),o=B(r);if(l.trim()==="")return{responseHeaders:o,value:new x({message:r.statusText,url:i,requestBodyValues:a,statusCode:r.status,responseHeaders:o,responseBody:l,isRetryable:t==null?void 0:t(r)})};try{const c=pt({text:l,schema:e});return{responseHeaders:o,value:new x({message:s(c),url:i,requestBodyValues:a,statusCode:r.status,responseHeaders:o,responseBody:l,data:c,isRetryable:t==null?void 0:t(r,c)})}}catch{return{responseHeaders:o,value:new x({message:r.statusText,url:i,requestBodyValues:a,statusCode:r.status,responseHeaders:o,responseBody:l,isRetryable:t==null?void 0:t(r)})}}},He=e=>async({response:s})=>{const t=B(s);if(s.body==null)throw new ze({});return{responseHeaders:t,value:s.body.pipeThrough(new TextDecoderStream).pipeThrough(new Be).pipeThrough(new TransformStream({transform({data:r},i){r!=="[DONE]"&&i.enqueue(Me({text:r,schema:e}))}}))}},ne=e=>async({response:s,url:t,requestBodyValues:r})=>{const i=await s.text(),a=Me({text:i,schema:e}),l=B(s);if(!a.success)throw new x({message:"Invalid JSON response",cause:a.error,statusCode:s.status,responseHeaders:l,responseBody:i,url:t,requestBodyValues:r});return{responseHeaders:l,value:a.value}},{btoa:ft,atob:Pt}=globalThis;function yt(e){let s="";for(let t=0;t<e.length;t++)s+=String.fromCodePoint(e[t]);return ft(s)}function bt(e){return e==null?void 0:e.replace(/\/$/,"")}function vt({prompt:e,useLegacyFunctionCalling:s=!1}){const t=[];for(const{role:r,content:i}of e)switch(r){case"system":{t.push({role:"system",content:i});break}case"user":{if(i.length===1&&i[0].type==="text"){t.push({role:"user",content:i[0].text});break}t.push({role:"user",content:i.map(a=>{var l;switch(a.type){case"text":return{type:"text",text:a.text};case"image":return{type:"image_url",image_url:{url:a.image instanceof URL?a.image.toString():`data:${(l=a.mimeType)!=null?l:"image/jpeg"};base64,${yt(a.image)}`}}}})});break}case"assistant":{let a="";const l=[];for(const o of i)switch(o.type){case"text":{a+=o.text;break}case"tool-call":{l.push({id:o.toolCallId,type:"function",function:{name:o.toolName,arguments:JSON.stringify(o.args)}});break}default:{const c=o;throw new Error(`Unsupported part: ${c}`)}}if(s){if(l.length>1)throw new k({functionality:"useLegacyFunctionCalling with multiple tool calls in one message"});t.push({role:"assistant",content:a,function_call:l.length>0?l[0].function:void 0})}else t.push({role:"assistant",content:a,tool_calls:l.length>0?l:void 0});break}case"tool":{for(const a of i)s?t.push({role:"function",name:a.toolName,content:JSON.stringify(a.result)}):t.push({role:"tool",tool_call_id:a.toolCallId,content:JSON.stringify(a.result)});break}default:{const a=r;throw new Error(`Unsupported role: ${a}`)}}return t}function pe(e){var s,t;return(t=(s=e==null?void 0:e.content)==null?void 0:s.map(({token:r,logprob:i,top_logprobs:a})=>({token:r,logprob:i,topLogprobs:a?a.map(({token:l,logprob:o})=>({token:l,logprob:o})):[]})))!=null?t:void 0}function V(e){switch(e){case"stop":return"stop";case"length":return"length";case"content_filter":return"content-filter";case"function_call":case"tool_calls":return"tool-calls";default:return"unknown"}}var re=n.object({error:n.object({message:n.string(),type:n.string().nullish(),param:n.any().nullish(),code:n.union([n.string(),n.number()]).nullish()})}),R=gt({errorSchema:re,errorToMessage:e=>e.error.message}),wt=class{constructor(e,s,t){this.specificationVersion="v1",this.modelId=e,this.settings=s,this.config=t}get supportsStructuredOutputs(){return this.settings.structuredOutputs===!0}get defaultObjectGenerationMode(){return this.supportsStructuredOutputs?"json":"tool"}get provider(){return this.config.provider}getArgs({mode:e,prompt:s,maxTokens:t,temperature:r,topP:i,topK:a,frequencyPenalty:l,presencePenalty:o,stopSequences:c,responseFormat:d,seed:m}){var g;const p=e.type,u=[];a!=null&&u.push({type:"unsupported-setting",setting:"topK"}),d!=null&&d.type==="json"&&d.schema!=null&&u.push({type:"unsupported-setting",setting:"responseFormat",details:"JSON response format schema is not supported"});const h=this.settings.useLegacyFunctionCalling;if(h&&this.settings.parallelToolCalls===!0)throw new k({functionality:"useLegacyFunctionCalling with parallelToolCalls"});if(h&&this.settings.structuredOutputs===!0)throw new k({functionality:"structuredOutputs with useLegacyFunctionCalling"});const f={model:this.modelId,logit_bias:this.settings.logitBias,logprobs:this.settings.logprobs===!0||typeof this.settings.logprobs=="number"?!0:void 0,top_logprobs:typeof this.settings.logprobs=="number"?this.settings.logprobs:typeof this.settings.logprobs=="boolean"&&this.settings.logprobs?0:void 0,user:this.settings.user,parallel_tool_calls:this.settings.parallelToolCalls,max_tokens:t,temperature:r,top_p:i,frequency_penalty:l,presence_penalty:o,stop:c,seed:m,response_format:(d==null?void 0:d.type)==="json"?{type:"json_object"}:void 0,messages:vt({prompt:s,useLegacyFunctionCalling:h})};switch(p){case"regular":return{args:{...f,...Et({mode:e,useLegacyFunctionCalling:h,structuredOutputs:this.settings.structuredOutputs})},warnings:u};case"object-json":return{args:{...f,response_format:this.settings.structuredOutputs===!0?{type:"json_schema",json_schema:{schema:e.schema,strict:!0,name:(g=e.name)!=null?g:"response",description:e.description}}:{type:"json_object"}},warnings:u};case"object-tool":return{args:h?{...f,function_call:{name:e.tool.name},functions:[{name:e.tool.name,description:e.tool.description,parameters:e.tool.parameters}]}:{...f,tool_choice:{type:"function",function:{name:e.tool.name}},tools:[{type:"function",function:{name:e.tool.name,description:e.tool.description,parameters:e.tool.parameters,strict:this.settings.structuredOutputs===!0?!0:void 0}}]},warnings:u};default:{const b=p;throw new Error(`Unsupported type: ${b}`)}}}async doGenerate(e){var s,t;const{args:r,warnings:i}=this.getArgs(e),{responseHeaders:a,value:l}=await $({url:this.config.url({path:"/chat/completions",modelId:this.modelId}),headers:P(this.config.headers(),e.headers),body:r,failedResponseHandler:R,successfulResponseHandler:ne(_t),abortSignal:e.abortSignal,fetch:this.config.fetch}),{messages:o,...c}=r,d=l.choices[0];return{text:(s=d.message.content)!=null?s:void 0,toolCalls:this.settings.useLegacyFunctionCalling&&d.message.function_call?[{toolCallType:"function",toolCallId:N(),toolName:d.message.function_call.name,args:d.message.function_call.arguments}]:(t=d.message.tool_calls)==null?void 0:t.map(m=>{var g;return{toolCallType:"function",toolCallId:(g=m.id)!=null?g:N(),toolName:m.function.name,args:m.function.arguments}}),finishReason:V(d.finish_reason),usage:{promptTokens:l.usage.prompt_tokens,completionTokens:l.usage.completion_tokens},rawCall:{rawPrompt:o,rawSettings:c},rawResponse:{headers:a},warnings:i,logprobs:pe(d.logprobs)}}async doStream(e){const{args:s,warnings:t}=this.getArgs(e),{responseHeaders:r,value:i}=await $({url:this.config.url({path:"/chat/completions",modelId:this.modelId}),headers:P(this.config.headers(),e.headers),body:{...s,stream:!0,stream_options:this.config.compatibility==="strict"?{include_usage:!0}:void 0},failedResponseHandler:R,successfulResponseHandler:He(kt),abortSignal:e.abortSignal,fetch:this.config.fetch}),{messages:a,...l}=s,o=[];let c="unknown",d={promptTokens:Number.NaN,completionTokens:Number.NaN},m;const{useLegacyFunctionCalling:g}=this.settings;return{stream:i.pipeThrough(new TransformStream({transform(p,u){var h,f,b,v,w,T,E,A,oe,ae,ie,le;if(!p.success){c="error",u.enqueue({type:"error",error:p.error});return}const j=p.value;if("error"in j){c="error",u.enqueue({type:"error",error:j.error});return}j.usage!=null&&(d={promptTokens:j.usage.prompt_tokens,completionTokens:j.usage.completion_tokens});const S=j.choices[0];if((S==null?void 0:S.finish_reason)!=null&&(c=V(S.finish_reason)),(S==null?void 0:S.delta)==null)return;const O=S.delta;O.content!=null&&u.enqueue({type:"text-delta",textDelta:O.content});const L=pe(S==null?void 0:S.logprobs);L!=null&&L.length&&(m===void 0&&(m=[]),m.push(...L));const ue=g&&O.function_call!=null?[{type:"function",id:N(),function:O.function_call,index:0}]:O.tool_calls;if(ue!=null)for(const _ of ue){const J=_.index;if(o[J]==null){if(_.type!=="function")throw new F({data:_,message:"Expected 'function' type."});if(_.id==null)throw new F({data:_,message:"Expected 'id' to be a string."});if(((h=_.function)==null?void 0:h.name)==null)throw new F({data:_,message:"Expected 'function.name' to be a string."});o[J]={id:_.id,type:"function",function:{name:_.function.name,arguments:(f=_.function.arguments)!=null?f:""}};const C=o[J];((b=C.function)==null?void 0:b.name)!=null&&((v=C.function)==null?void 0:v.arguments)!=null&&ce(C.function.arguments)&&(u.enqueue({type:"tool-call-delta",toolCallType:"function",toolCallId:C.id,toolName:C.function.name,argsTextDelta:C.function.arguments}),u.enqueue({type:"tool-call",toolCallType:"function",toolCallId:(w=C.id)!=null?w:N(),toolName:C.function.name,args:C.function.arguments}));continue}const I=o[J];((T=_.function)==null?void 0:T.arguments)!=null&&(I.function.arguments+=(A=(E=_.function)==null?void 0:E.arguments)!=null?A:""),u.enqueue({type:"tool-call-delta",toolCallType:"function",toolCallId:I.id,toolName:I.function.name,argsTextDelta:(oe=_.function.arguments)!=null?oe:""}),((ae=I.function)==null?void 0:ae.name)!=null&&((ie=I.function)==null?void 0:ie.arguments)!=null&&ce(I.function.arguments)&&u.enqueue({type:"tool-call",toolCallType:"function",toolCallId:(le=I.id)!=null?le:N(),toolName:I.function.name,args:I.function.arguments})}},flush(p){p.enqueue({type:"finish",finishReason:c,logprobs:m,usage:d})}})),rawCall:{rawPrompt:a,rawSettings:l},rawResponse:{headers:r},warnings:t}}},_t=n.object({choices:n.array(n.object({message:n.object({role:n.literal("assistant").nullish(),content:n.string().nullish(),function_call:n.object({arguments:n.string(),name:n.string()}).nullish(),tool_calls:n.array(n.object({id:n.string().nullish(),type:n.literal("function"),function:n.object({name:n.string(),arguments:n.string()})})).nullish()}),index:n.number(),logprobs:n.object({content:n.array(n.object({token:n.string(),logprob:n.number(),top_logprobs:n.array(n.object({token:n.string(),logprob:n.number()}))})).nullable()}).nullish(),finish_reason:n.string().nullish()})),usage:n.object({prompt_tokens:n.number(),completion_tokens:n.number()})}),kt=n.union([n.object({choices:n.array(n.object({delta:n.object({role:n.enum(["assistant"]).nullish(),content:n.string().nullish(),function_call:n.object({name:n.string().optional(),arguments:n.string().optional()}).nullish(),tool_calls:n.array(n.object({index:n.number(),id:n.string().nullish(),type:n.literal("function").optional(),function:n.object({name:n.string().nullish(),arguments:n.string().nullish()})})).nullish()}).nullish(),logprobs:n.object({content:n.array(n.object({token:n.string(),logprob:n.number(),top_logprobs:n.array(n.object({token:n.string(),logprob:n.number()}))})).nullable()}).nullish(),finish_reason:n.string().nullable().optional(),index:n.number()})),usage:n.object({prompt_tokens:n.number(),completion_tokens:n.number()}).nullish()}),re]);function Et({mode:e,useLegacyFunctionCalling:s=!1,structuredOutputs:t=!1}){var r;const i=(r=e.tools)!=null&&r.length?e.tools:void 0;if(i==null)return{tools:void 0,tool_choice:void 0};const a=e.toolChoice;if(s){const c=i.map(m=>({name:m.name,description:m.description,parameters:m.parameters}));if(a==null)return{functions:c,function_call:void 0};switch(a.type){case"auto":case"none":case void 0:return{functions:c,function_call:void 0};case"required":throw new k({functionality:"useLegacyFunctionCalling and toolChoice: required"});default:return{functions:c,function_call:{name:a.toolName}}}}const l=i.map(c=>({type:"function",function:{name:c.name,description:c.description,parameters:c.parameters,strict:t===!0?!0:void 0}}));if(a==null)return{tools:l,tool_choice:void 0};const o=a.type;switch(o){case"auto":case"none":case"required":return{tools:l,tool_choice:o};case"tool":return{tools:l,tool_choice:{type:"function",function:{name:a.toolName}}};default:{const c=o;throw new Error(`Unsupported tool choice type: ${c}`)}}}function It({prompt:e,inputFormat:s,user:t="user",assistant:r="assistant"}){if(s==="prompt"&&e.length===1&&e[0].role==="user"&&e[0].content.length===1&&e[0].content[0].type==="text")return{prompt:e[0].content[0].text};let i="";e[0].role==="system"&&(i+=`${e[0].content}

`,e=e.slice(1));for(const{role:a,content:l}of e)switch(a){case"system":throw new Ye({message:"Unexpected system message in prompt: ${content}",prompt:e});case"user":{const o=l.map(c=>{switch(c.type){case"text":return c.text;case"image":throw new k({functionality:"images"})}}).join("");i+=`${t}:
${o}

`;break}case"assistant":{const o=l.map(c=>{switch(c.type){case"text":return c.text;case"tool-call":throw new k({functionality:"tool-call messages"})}}).join("");i+=`${r}:
${o}

`;break}case"tool":throw new k({functionality:"tool messages"});default:{const o=a;throw new Error(`Unsupported role: ${o}`)}}return i+=`${r}:
`,{prompt:i,stopSequences:[`
${t}:`]}}function de(e){return e==null?void 0:e.tokens.map((s,t)=>({token:s,logprob:e.token_logprobs[t],topLogprobs:e.top_logprobs?Object.entries(e.top_logprobs[t]).map(([r,i])=>({token:r,logprob:i})):[]}))}var Ct=class{constructor(e,s,t){this.specificationVersion="v1",this.defaultObjectGenerationMode=void 0,this.modelId=e,this.settings=s,this.config=t}get provider(){return this.config.provider}getArgs({mode:e,inputFormat:s,prompt:t,maxTokens:r,temperature:i,topP:a,topK:l,frequencyPenalty:o,presencePenalty:c,stopSequences:d,responseFormat:m,seed:g}){var p;const u=e.type,h=[];l!=null&&h.push({type:"unsupported-setting",setting:"topK"}),m!=null&&m.type!=="text"&&h.push({type:"unsupported-setting",setting:"responseFormat",details:"JSON response format is not supported."});const{prompt:f,stopSequences:b}=It({prompt:t,inputFormat:s}),v=[...b??[],...d??[]],w={model:this.modelId,echo:this.settings.echo,logit_bias:this.settings.logitBias,logprobs:typeof this.settings.logprobs=="number"?this.settings.logprobs:typeof this.settings.logprobs=="boolean"&&this.settings.logprobs?0:void 0,suffix:this.settings.suffix,user:this.settings.user,max_tokens:r,temperature:i,top_p:a,frequency_penalty:o,presence_penalty:c,seed:g,prompt:f,stop:v.length>0?v:void 0};switch(u){case"regular":{if((p=e.tools)!=null&&p.length)throw new k({functionality:"tools"});if(e.toolChoice)throw new k({functionality:"toolChoice"});return{args:w,warnings:h}}case"object-json":throw new k({functionality:"object-json mode"});case"object-tool":throw new k({functionality:"object-tool mode"});default:{const T=u;throw new Error(`Unsupported type: ${T}`)}}}async doGenerate(e){const{args:s,warnings:t}=this.getArgs(e),{responseHeaders:r,value:i}=await $({url:this.config.url({path:"/completions",modelId:this.modelId}),headers:P(this.config.headers(),e.headers),body:s,failedResponseHandler:R,successfulResponseHandler:ne(xt),abortSignal:e.abortSignal,fetch:this.config.fetch}),{prompt:a,...l}=s,o=i.choices[0];return{text:o.text,usage:{promptTokens:i.usage.prompt_tokens,completionTokens:i.usage.completion_tokens},finishReason:V(o.finish_reason),logprobs:de(o.logprobs),rawCall:{rawPrompt:a,rawSettings:l},rawResponse:{headers:r},warnings:t}}async doStream(e){const{args:s,warnings:t}=this.getArgs(e),{responseHeaders:r,value:i}=await $({url:this.config.url({path:"/completions",modelId:this.modelId}),headers:P(this.config.headers(),e.headers),body:{...s,stream:!0,stream_options:this.config.compatibility==="strict"?{include_usage:!0}:void 0},failedResponseHandler:R,successfulResponseHandler:He(St),abortSignal:e.abortSignal,fetch:this.config.fetch}),{prompt:a,...l}=s;let o="unknown",c={promptTokens:Number.NaN,completionTokens:Number.NaN},d;return{stream:i.pipeThrough(new TransformStream({transform(m,g){if(!m.success){o="error",g.enqueue({type:"error",error:m.error});return}const p=m.value;if("error"in p){o="error",g.enqueue({type:"error",error:p.error});return}p.usage!=null&&(c={promptTokens:p.usage.prompt_tokens,completionTokens:p.usage.completion_tokens});const u=p.choices[0];(u==null?void 0:u.finish_reason)!=null&&(o=V(u.finish_reason)),(u==null?void 0:u.text)!=null&&g.enqueue({type:"text-delta",textDelta:u.text});const h=de(u==null?void 0:u.logprobs);h!=null&&h.length&&(d===void 0&&(d=[]),d.push(...h))},flush(m){m.enqueue({type:"finish",finishReason:o,logprobs:d,usage:c})}})),rawCall:{rawPrompt:a,rawSettings:l},rawResponse:{headers:r},warnings:t}}},xt=n.object({choices:n.array(n.object({text:n.string(),finish_reason:n.string(),logprobs:n.object({tokens:n.array(n.string()),token_logprobs:n.array(n.number()),top_logprobs:n.array(n.record(n.string(),n.number())).nullable()}).nullable().optional()})),usage:n.object({prompt_tokens:n.number(),completion_tokens:n.number()})}),St=n.union([n.object({choices:n.array(n.object({text:n.string(),finish_reason:n.string().nullish(),index:n.number(),logprobs:n.object({tokens:n.array(n.string()),token_logprobs:n.array(n.number()),top_logprobs:n.array(n.record(n.string(),n.number())).nullable()}).nullable().optional()})),usage:n.object({prompt_tokens:n.number(),completion_tokens:n.number()}).optional().nullable()}),re]),Tt=class{constructor(e,s,t){this.specificationVersion="v1",this.modelId=e,this.settings=s,this.config=t}get provider(){return this.config.provider}get maxEmbeddingsPerCall(){var e;return(e=this.settings.maxEmbeddingsPerCall)!=null?e:2048}get supportsParallelCalls(){var e;return(e=this.settings.supportsParallelCalls)!=null?e:!0}async doEmbed({values:e,headers:s,abortSignal:t}){if(e.length>this.maxEmbeddingsPerCall)throw new et({provider:this.provider,modelId:this.modelId,maxEmbeddingsPerCall:this.maxEmbeddingsPerCall,values:e});const{responseHeaders:r,value:i}=await $({url:this.config.url({path:"/embeddings",modelId:this.modelId}),headers:P(this.config.headers(),s),body:{model:this.modelId,input:e,encoding_format:"float",dimensions:this.settings.dimensions,user:this.settings.user},failedResponseHandler:R,successfulResponseHandler:ne(jt),abortSignal:t,fetch:this.config.fetch});return{embeddings:i.data.map(a=>a.embedding),usage:i.usage?{tokens:i.usage.prompt_tokens}:void 0,rawResponse:{headers:r}}}},jt=n.object({data:n.array(n.object({embedding:n.array(n.number())})),usage:n.object({prompt_tokens:n.number()}).nullish()});function At(e={}){var s,t,r;const i=(t=bt((s=e.baseURL)!=null?s:e.baseUrl))!=null?t:"https://api.openai.com/v1",a=(r=e.compatibility)!=null?r:"compatible",l=()=>({Authorization:`Bearer ${ot({apiKey:e.apiKey,environmentVariableName:"OPENAI_API_KEY",description:"OpenAI"})}`,"OpenAI-Organization":e.organization,"OpenAI-Project":e.project,...e.headers}),o=(p,u={})=>new wt(p,u,{provider:"openai.chat",url:({path:h})=>`${i}${h}`,headers:l,compatibility:a,fetch:e.fetch}),c=(p,u={})=>new Ct(p,u,{provider:"openai.completion",url:({path:h})=>`${i}${h}`,headers:l,compatibility:a,fetch:e.fetch}),d=(p,u={})=>new Tt(p,u,{provider:"openai.embedding",url:({path:h})=>`${i}${h}`,headers:l,fetch:e.fetch}),m=(p,u)=>{if(new.target)throw new Error("The OpenAI model function cannot be called with the new keyword.");return p==="gpt-3.5-turbo-instruct"?c(p,u):o(p,u)},g=function(p,u){return m(p,u)};return g.languageModel=m,g.chat=o,g.completion=c,g.embedding=d,g.textEmbedding=d,g}At({compatibility:"strict"});export{At as createOpenAI};
